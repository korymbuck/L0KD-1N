<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Friends Leaderboard</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="styles-friends.css" />
    <!-- Removed duplicate styles.css link -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <header>
      <h1>Friends Leaderboard</h1>
      <nav>
        <a
          href="index.html"
          style="color: #fcfaee; text-decoration: underline; font-weight: 600"
          >Go Home</a
        >
      </nav>
    </header>

    <main>
      <section class="add-friend-section">
        <h2>Add Friend</h2>
        <input
          type="text"
          id="add-friend-input"
          placeholder="Enter friend's username"
        />
        <button id="add-friend-button">Add Friend</button>
        <div id="friend-error"></div>
      </section>

      <section class="leaderboard">
        <h2>LEADERBOARD</h2>
        <div id="friends-list">
          <!-- Friends will be loaded here by JavaScript -->
        </div>
      </section>
    </main>

    <script type="module">
      const supabaseUrl = "https://nglasnytfnyavhsxjuau.supabase.co";
      // Use the correct Supabase Key from your script.js
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbGFzbnl0Zm55YXZoc3hqdWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4MTg4OTQsImV4cCI6MjA2MjM5NDg5NH0.tIDB4uS0jYojQmWRG2EnrxXss3PhcWbFCnVF4_j4dzw";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      const addFriendInput = document.getElementById("add-friend-input");
      const addFriendButton = document.getElementById("add-friend-button");
      const friendsList = document.getElementById("friends-list");
      const friendError = document.getElementById("friend-error");

      let currentUser = null;

      async function fetchFriends() {
        if (!currentUser) return;
        friendError.textContent = "";

        const { data: friendsData, error } = await supabase
          .from("friends")
          .select(
            `
            friend_id,
            profiles:friend_id (
              username,
              workout_stats ( total_pushups, total_squats, total_situps )
            )
          `
          )
          .eq("user_id", currentUser.id);

        if (error) {
          console.error("Error fetching friends:", error);
          friendError.textContent = "Failed to load friends list.";
          return;
        }

        const processedFriends = friendsData.map((f) => {
          const profile = f.profiles;
          const stats =
            profile?.workout_stats && profile.workout_stats.length > 0
              ? profile.workout_stats[0]
              : { total_pushups: 0, total_squats: 0, total_situps: 0 };
          return {
            friend_id: f.friend_id,
            username: profile?.username || "Unknown",
            total_pushups: stats.total_pushups || 0,
            total_squats: stats.total_squats || 0,
            total_situps: stats.total_situps || 0,
          };
        });

        const sortedFriends = processedFriends.sort((a, b) => {
          const aTotal = a.total_pushups + a.total_squats + a.total_situps;
          const bTotal = b.total_pushups + b.total_squats + b.total_situps;
          return bTotal - aTotal;
        });

        friendsList.innerHTML = sortedFriends
          .map((f, i) => {
            const totalWorkouts =
              f.total_pushups + f.total_squats + f.total_situps;
            const isSelf = f.friend_id === currentUser.id;
            return `
          <div class="friend-card">
            <strong>#${i + 1} ${
              isSelf ? '<span style="color:#FFD700">You</span>' : f.username
            }</strong><br />
            Pushups: ${f.total_pushups}, 
            Squats: ${f.total_squats}, 
            Situps: ${f.total_situps}<br />
            <em>Total Workouts: ${totalWorkouts}</em><br />
            ${
              !isSelf
                ? `<button class='remove-friend' data-id='${f.friend_id}'>Remove</button>`
                : ""
            }
          </div>
        `;
          })
          .join("");

        document.querySelectorAll(".remove-friend").forEach((btn) => {
          btn.addEventListener("click", async (event) => {
            const friendIdToRemove = event.target.dataset.id;
            await removeFriend(friendIdToRemove);
          });
        });
      }

      async function addFriend() {
        if (!currentUser) return;
        const usernameToAdd = addFriendInput.value.trim();
        friendError.textContent = "";

        if (!usernameToAdd) {
          friendError.textContent = "Please enter a username.";
          return;
        }

        // Prevent adding self if desired, though current structure allows it for leaderboard visibility
        // const { data: { user: selfProfile } } = await supabase.auth.getUser();
        // if (selfProfile && selfProfile.user_metadata?.username === usernameToAdd) {
        //   friendError.textContent = "You cannot add yourself.";
        //   return;
        // }

        const { data: profile, error: lookupError } = await supabase
          .from("profiles")
          .select("id")
          .eq("username", usernameToAdd)
          .single();

        if (lookupError || !profile) {
          friendError.textContent = "User not found.";
          console.error("User lookup error:", lookupError);
          return;
        }

        if (profile.id === currentUser.id) {
          friendError.textContent =
            "You are trying to add yourself. If you want to appear on your leaderboard, this is how!";
          // Optionally, you could auto-add self to friends list on first load or signup.
        }

        const { data: existing, error: existingError } = await supabase
          .from("friends")
          .select("id")
          .eq("user_id", currentUser.id)
          .eq("friend_id", profile.id)
          .maybeSingle(); // Use maybeSingle to not error if no row found

        if (existingError && existingError.code !== "PGRST116") {
          // PGRST116 is "No rows found"
          console.error("Error checking existing friend:", existingError);
          friendError.textContent = "Could not check friend status.";
          return;
        }

        if (existing) {
          friendError.textContent = "You have already added this friend.";
          return;
        }

        const { error: insertError } = await supabase.from("friends").insert({
          user_id: currentUser.id,
          friend_id: profile.id,
        });

        if (insertError) {
          console.error("Error adding friend:", insertError);
          friendError.textContent =
            "Could not add friend. They may need to set up their profile first.";
          return;
        }

        addFriendInput.value = "";
        fetchFriends(); // Refresh the list
      }

      async function removeFriend(friendIdToRemove) {
        if (!currentUser || !friendIdToRemove) return;

        const confirmed = confirm(
          "Are you sure you want to remove this friend?"
        );
        if (!confirmed) return;

        const { error } = await supabase
          .from("friends")
          .delete()
          .eq("user_id", currentUser.id)
          .eq("friend_id", friendIdToRemove);

        if (error) {
          console.error("Error removing friend:", error);
          friendError.textContent = "Could not remove friend.";
        } else {
          fetchFriends(); // Refresh the list
        }
      }

      addFriendButton.addEventListener("click", addFriend);

      // Initial load
      supabase.auth.getSession().then(({ data: { session } }) => {
        if (session?.user) {
          currentUser = session.user;
          fetchFriends();
        } else {
          // Redirect to login if not authenticated, or show a message
          window.location.href = "index.html";
        }
      });
      // Listen for auth changes to keep currentUser updated
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === "SIGNED_IN") {
          currentUser = session.user;
          fetchFriends();
        } else if (event === "SIGNED_OUT") {
          currentUser = null;
          friendsList.innerHTML =
            "<p>Please log in to see the leaderboard.</p>";
          // Optionally redirect: window.location.href = "index.html";
        }
      });
    </script>
  </body>
</html>
